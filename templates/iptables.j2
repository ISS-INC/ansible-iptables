# This file was generated by Ansible
# Do NOT modify this file by hand!
# {{ ansible_managed }}

{% if iptables_enable_nat %}
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
{% endif %}

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:DOCKER - [0:0]
:PRE_DOCKER_FILTER - [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
{% if iptables_allow_icmp %}
# Accept icmp ping requests.
-A INPUT -p icmp -j ACCEPT
{% endif %}
{% if iptables_allow_ntp %}
# Allow NTP traffic for time synchronization.
iptables -A OUTPUT -p udp --dport 123 -j ACCEPT
iptables -A INPUT -p udp --sport 123 -j ACCEPT
{% endif %}
# Accept all from localhost
-A INPUT -i lo -j ACCEPT
# Accept all docker0 interface for inter container comms
-A INPUT -i docker0 -j ACCEPT
# Accept on specfic ports
{% for port in iptables_allowed_tcp_ports %}
-A INPUT -m state --state NEW -m tcp -p tcp --dport {{ port }} -j ACCEPT
{% endfor %}
{% for port in iptables_allowed_udp_ports %}
-A INPUT -m state --state NEW -m udp -p udp --dport {{ port }} -j ACCEPT
{% endfor %}
# BEGIN Forwarded ports.
{% for forward in iptables_forwarded_tcp_ports %}
-I PREROUTING -p tcp --dport {{forward.from}} -j REDIRECT --to-port {{forward.to}}
{% endfor %}
{% for forward in iptables_forwarded_udp_ports %}
-I PREROUTING -p udp --dport {{forward.from}} -j REDIRECT --to-port {{forward.to}}
{% endfor %}
# END Forwarded ports.
# BEGIN Raw rules
{% for rule in iptables_raw_rules %}
{{rule}}
{% endfor %}
# END Raw rules
# docker places its rules -after- this statement. Packets must pass the PRE_DOCKER_FILTER policy
# in order to reach the internal container mapping rules.
-A DOCKER -j PRE_DOCKER_FILTER

# the PRE_DOCKER_FILTER chain restricts external access to this host
-A PRE_DOCKER_FILTER -m state --state RELATED,ESTABLISHED -j ACCEPT
{% for port in iptables_allowed_docker_tcp_ports %}
-A PRE_DOCKER_FILTER -m state --state NEW -m tcp -p tcp --dport {{ port }} -j ACCEPT
{% endfor %}
{% if iptables_logging %}
# Logging
-A PRE_DOCKER_FILTER -m limit --limit 15/minute -j LOG --log-level 7 --log-prefix "Dropped by iptables: "
-A INPUT -m limit --limit 15/minute -j LOG --log-level 7 --log-prefix "Dropped by iptables: "
{% endif %}
{% if iptables_deny_all %}
# Drop all other
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A PRE_DOCKER_FILTER -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
{% endif %}
COMMIT
